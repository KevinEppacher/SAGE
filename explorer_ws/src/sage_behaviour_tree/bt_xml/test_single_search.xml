<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="SAGE_SingleObject">
  <BehaviorTree ID="SAGE_SingleObject">
    <Sequence>
      <SetBlackboard value="0"
                     output_key="min_yaw"/>
      <SetBlackboard value="6.28319"
                     output_key="max_yaw"/>
      <SetParameterNode target_node="/value_map/value_map"
                        parameter_name="semantic_map.confidence_sharpness"
                        value="0.5"/>
      <RetryUntilSuccessful num_attempts="-1">
        <ReactiveFallback>
          <Sequence>
            <IsDetected detection_threshold="{detection_threshold}"
                        detection_graph_node_topic="/detection_graph_nodes/graph_nodes"
                        max_missed_ticks="{max_missed_ticks}"
                        graph_nodes="{graph_nodes}"/>
            <GoToGraphNode graph_nodes="{graph_nodes}"
                           approach_radius="3"
                           goal_topic="/goal_pose"/>
          </Sequence>
          <Sequence>
            <Sequence>
              <SetParameterNode target_node="/value_map/value_map"
                                parameter_name="semantic_map.decay_factor"
                                value="1"/>
              <SetParameterNode target_node="/value_map/value_map"
                                parameter_name="semantic_map.confidence_sharpness"
                                value="0.5"/>
            </Sequence>
            <Spin360 min_yaw="{min_yaw}"
                     max_yaw="{max_yaw}"
                     spin_duration="15.0"/>
            <Sequence>
              <SetParameterNode target_node="/value_map/value_map"
                                parameter_name="semantic_map.decay_factor"
                                value="0.99"/>
              <SetParameterNode target_node="/value_map/value_map"
                                parameter_name="semantic_map.confidence_sharpness"
                                value="3"/>
            </Sequence>
            <ReactiveSequence>
              <IsDetected detection_threshold="0.05"
                          detection_graph_node_topic="/exploration_graph_nodes/graph_nodes"
                          max_missed_ticks="8"
                          graph_nodes="{exploration_nodes}"/>
              <Delay delay_msec="1000">
                <GoToGraphNode graph_nodes="{exploration_nodes}"
                               approach_radius="0.5"
                               goal_topic="/goal_pose"/>
              </Delay>
            </ReactiveSequence>
            <SetBlackboard value="0.523"
                           output_key="max_yaw"/>
            <SetBlackboard value="-0.523"
                           output_key="min_yaw"/>
            <AlwaysFailure/>
          </Sequence>
        </ReactiveFallback>
      </RetryUntilSuccessful>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="GoToGraphNode">
      <input_port name="graph_nodes"/>
      <input_port name="approach_radius"/>
      <input_port name="goal_topic"/>
    </Action>
    <Condition ID="IsDetected">
      <input_port name="detection_threshold"
                  default="0.8"/>
      <input_port name="detection_graph_node_topic"
                  default="/detection_graph_nodes/graph_nodes"/>
      <input_port name="max_missed_ticks"
                  default="8"/>
      <output_port name="graph_nodes"
                   default="latest_nodes"/>
    </Condition>
    <Action ID="SetParameterNode">
      <input_port name="target_node"
                  default="/value_map"/>
      <input_port name="parameter_name"
                  default="decay_factor"/>
      <input_port name="value"
                  default="1.0"/>
    </Action>
    <Action ID="Spin360">
      <input_port name="min_yaw"
                  default="-3.14159"/>
      <input_port name="max_yaw"
                  default="3.14159"/>
      <input_port name="spin_duration"
                  default="10.0"/>
    </Action>
  </TreeNodesModel>

</root>
