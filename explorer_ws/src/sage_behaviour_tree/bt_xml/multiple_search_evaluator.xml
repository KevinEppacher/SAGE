<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="SAGE_MultiObject">
  <BehaviorTree ID="SAGE_MultiObject">
    <ForEachEvaluationPrompt evaluation_event_topic="/evaluation/event"
                             iteration_status_topic="/evaluation/iteration_status"
                             targetObject="{target_object}">
      <SubTree ID="SAGE_SingleObject"
               object=""
               _autoremap="true"/>
    </ForEachEvaluationPrompt>
  </BehaviorTree>

  <BehaviorTree ID="SAGE_SingleObject">
    <Sequence>
      <SetBlackboard value="false"
                     output_key="object_found"/>
      <SetBlackboard value="true"
                     output_key="any_exploration_nodes"/>
      <CallEmptyService service_name="/exploration_map/clear"/>
      <CallEmptyService service_name="/value_map/clear"/>
      <PublishSemanticPrompt text_query="{target_object}"
                             topic="/user_prompt"/>
      <KeepRunningUntilObjectFound object_found="{object_found}"
                                   any_exploration_nodes="{any_exploration_nodes}">
        <ReactiveFallback>
          <Sequence name="Detection sequence">
            <IsDetected name="Target object detected?"
                        detection_threshold="0.85"
                        detection_graph_node_topic="/fused/detection_graph_nodes/graph_nodes"
                        graph_nodes="{detected_graph_node}"/>
            <ApproachPoseAdjustor approach_radius="2.5"
                                  reachable_graph_node="{reachable_graph_node}"
                                  graph_node="{detected_graph_node}">
              <GoToGraphNode name="Go to likiest GraphNode"
                             graph_nodes="{reachable_graph_node}"
                             approach_radius="2"
                             goal_topic="/goal_pose"
                             robot_frame="base_link"
                             map_frame="map"
                             timeout="10"/>
            </ApproachPoseAdjustor>
            <RealignToObject detected_graph_node="{detected_graph_node}"
                             spinDuration="5.0"/>
            <SaveImageAction imageTopic="/yoloe/overlay"
                             savePath="/app/image.png"/>
            <SetBlackboard value="true"
                           output_key="object_found"/>
          </Sequence>
          <Sequence name="Exploration sequence">
            <SetParameterNode target_node="/value_map/value_map"
                              parameter_name="semantic_map.decay_factor"
                              value="1"/>
            <SeekoutGraphNodes name="Observe all possible GraphNodes"
                               graph_node_topic="/fused/exploration_graph_nodes/graph_nodes"
                               robot_frame="base_link"
                               map_frame="map"
                               sight_horizon="10"
                               min_yaw_default="-0.523"
                               max_yaw_default="0.523"
                               min_yaw="{min_yaw}"
                               max_yaw="{max_yaw}"/>
            <Spin turnLeftAngle="{max_yaw}"
                  turnRightAngle="{min_yaw}"
                  spinDuration="5"/>
            <SetParameterNode target_node="/value_map/value_map"
                              parameter_name="semantic_map.decay_factor"
                              value="0.999"/>
            <ReactiveSequence>
              <Fallback>
                <IsDetected name="Already explored all available GraphNodes?"
                            detection_threshold="0.0"
                            detection_graph_node_topic="/fused/exploration_graph_nodes/graph_nodes"
                            graph_nodes="{likiest_explorer_node}"/>
                <SetBlackboard value="false"
                               output_key="any_exploration_nodes"/>
              </Fallback>
              <ApproachPoseAdjustor approach_radius="2.5"
                                    reachable_graph_node="{reachable_graph_node}"
                                    graph_node="{detected_graph_node}">
                <GoToGraphNode name="Go to likiest GraphNode"
                               graph_nodes="{likiest_explorer_node}"
                               approach_radius="0.8"
                               goal_topic="/goal_pose"
                               robot_frame="base_link"
                               map_frame="map"
                               timeout="10"/>
              </ApproachPoseAdjustor>
            </ReactiveSequence>
          </Sequence>
        </ReactiveFallback>
      </KeepRunningUntilObjectFound>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Decorator ID="ApproachPoseAdjustor">
      <input_port name="approach_radius"
                  default="1.000000"
                  type="double">Maximum projection distance (m)</input_port>
      <output_port name="reachable_graph_node"
                   type="std::shared_ptr&lt;graph_node_msgs::msg::GraphNode_&lt;std::allocator&lt;void&gt; &gt; &gt;">Adjusted reachable node</output_port>
      <input_port name="graph_node"
                  type="std::shared_ptr&lt;graph_node_msgs::msg::GraphNode_&lt;std::allocator&lt;void&gt; &gt; &gt;">Input target node</input_port>
    </Decorator>
    <Action ID="CallEmptyService">
      <input_port name="service_name"
                  default="/clear_exploration_map"/>
    </Action>
    <Decorator ID="ForEachEvaluationPrompt">
      <input_port name="evaluation_event_topic"
                  default="/evaluation/event"/>
      <input_port name="iteration_status_topic"
                  default="/evaluation/iteration_status"/>
      <output_port name="targetObject"/>
    </Decorator>
    <Action ID="GoToGraphNode">
      <input_port name="graph_nodes"/>
      <input_port name="approach_radius"/>
      <input_port name="goal_topic"/>
      <input_port name="robot_frame"/>
      <input_port name="map_frame"/>
      <input_port name="timeout"
                  default="60.0"/>
    </Action>
    <Condition ID="IsDetected">
      <input_port name="detection_threshold"
                  default="0.8"/>
      <input_port name="detection_graph_node_topic"
                  default="/detection_graph_nodes/graph_nodes"/>
      <output_port name="graph_nodes"
                   default="latest_nodes"/>
    </Condition>
    <Decorator ID="KeepRunningUntilObjectFound">
      <input_port name="object_found"
                  default="false"/>
      <input_port name="any_exploration_nodes"
                  default="true"/>
    </Decorator>
    <Action ID="PublishSemanticPrompt">
      <input_port name="text_query"/>
      <input_port name="topic"
                  default="/user_prompt"/>
    </Action>
    <Action ID="RealignToObject">
      <input_port name="detected_graph_node"/>
      <input_port name="spinDuration"
                  default="5.0"/>
    </Action>
    <SubTree ID="SAGE_SingleObject">
      <input_port name="object"/>
    </SubTree>
    <Action ID="SaveImageAction">
      <input_port name="imageTopic"
                  default="/yoloe/overlay"/>
      <input_port name="savePath"
                  default="/tmp/overlay.jpg"/>
    </Action>
    <Action ID="SeekoutGraphNodes">
      <input_port name="graph_node_topic"
                  default="/fused/exploration_graph_nodes/graph_nodes"/>
      <input_port name="robot_frame"
                  default="base_link"/>
      <input_port name="map_frame"
                  default="map"/>
      <input_port name="sight_horizon"
                  default="10.0"/>
      <input_port name="min_yaw_default"
                  default="-0.523"/>
      <input_port name="max_yaw_default"
                  default="0.523"/>
      <output_port name="min_yaw"/>
      <output_port name="max_yaw"/>
    </Action>
    <Action ID="SetParameterNode">
      <input_port name="target_node"
                  default="/value_map"/>
      <input_port name="parameter_name"
                  default="decay_factor"/>
      <input_port name="value"
                  default="1.0"/>
    </Action>
    <Action ID="Spin">
      <input_port name="turnLeftAngle"
                  default="3.14159"/>
      <input_port name="turnRightAngle"
                  default="-3.14159"/>
      <input_port name="spinDuration"
                  default="10.0"/>
    </Action>
  </TreeNodesModel>

</root>
