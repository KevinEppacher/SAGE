<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="SAGE_SingleObject">
  <BehaviorTree ID="SAGE_SingleObject">
    <KeepRunningUntilObjectFound>
      <ReactiveFallback>
        <Sequence>
          <IsDetected name="Target object detected?"
                      detection_threshold="0.85"
                      detection_graph_node_topic="/fused/detection_graph_nodes/graph_nodes"
                      graph_nodes="{graph_nodes}"/>
          <SaveImageAction imageTopic="/yoloe/overlay"
                           savePath="/app/image.png"/>
        </Sequence>
        <Sequence>
          <SetParameterNode target_node="/value_map/value_map"
                            parameter_name="semantic_map.decay_factor"
                            value="1"/>
          <SeekoutGraphNodes name="Observe all possible GraphNodes"
                             graph_node_topic="/fused/exploration_graph_nodes/graph_nodes"
                             robot_frame="base_link"
                             map_frame="map"
                             sight_horizon="10.0"
                             min_yaw_default="-0.523"
                             max_yaw_default="0.523"
                             min_yaw="{min_yaw}"
                             max_yaw="{max_yaw}"/>
          <Spin turnLeftAngle="{max_yaw}"
                turnRightAngle="{min_yaw}"
                spinDuration="15.0"/>
          <Delay delay_msec="200">
            <SetParameterNode target_node="/value_map/value_map"
                              parameter_name="semantic_map.decay_factor"
                              value="0.999"/>
          </Delay>
          <ReactiveSequence>
            <IsDetected name="Already explored all available GraphNodes?"
                        detection_threshold="0.0"
                        detection_graph_node_topic="/fused/exploration_graph_nodes/graph_nodes"
                        graph_nodes="{exploration_nodes}"/>
            <GoToGraphNode name="Go to likiest GraphNode"
                           graph_nodes="{exploration_nodes}"
                           approach_radius="2"
                           goal_topic="/goal_pose"
                           robot_frame="base_link"
                           map_frame="map"
                           max_changed_targets="1"/>
          </ReactiveSequence>
        </Sequence>
      </ReactiveFallback>
    </KeepRunningUntilObjectFound>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="GoToGraphNode">
      <input_port name="graph_nodes"/>
      <input_port name="approach_radius"/>
      <input_port name="goal_topic"/>
      <input_port name="robot_frame"/>
      <input_port name="map_frame"/>
      <input_port name="max_changed_targets"
                  default="1"/>
    </Action>
    <Condition ID="IsDetected">
      <input_port name="detection_threshold"
                  default="0.8"/>
      <input_port name="detection_graph_node_topic"
                  default="/detection_graph_nodes/graph_nodes"/>
      <output_port name="graph_nodes"
                   default="latest_nodes"/>
    </Condition>
    <Decorator ID="KeepRunningUntilObjectFound"/>
    <Action ID="SaveImageAction">
      <input_port name="imageTopic"
                  default="/yoloe/overlay"/>
      <input_port name="savePath"
                  default="/tmp/overlay.jpg"/>
    </Action>
    <Action ID="SeekoutGraphNodes">
      <input_port name="graph_node_topic"
                  default="/fused/exploration_graph_nodes/graph_nodes"/>
      <input_port name="robot_frame"
                  default="base_link"/>
      <input_port name="map_frame"
                  default="map"/>
      <input_port name="sight_horizon"
                  default="10.0"/>
      <input_port name="min_yaw_default"
                  default="-0.523"/>
      <input_port name="max_yaw_default"
                  default="0.523"/>
      <output_port name="min_yaw"/>
      <output_port name="max_yaw"/>
    </Action>
    <Action ID="SetParameterNode">
      <input_port name="target_node"
                  default="/value_map"/>
      <input_port name="parameter_name"
                  default="decay_factor"/>
      <input_port name="value"
                  default="1.0"/>
    </Action>
    <Action ID="Spin">
      <input_port name="turnLeftAngle"
                  default="3.14159"/>
      <input_port name="turnRightAngle"
                  default="-3.14159"/>
      <input_port name="spinDuration"
                  default="10.0"/>
    </Action>
  </TreeNodesModel>

</root>
